name: Build & Evaluate (in Docker)
on: 
  workflow_dispatch:
  push:
    branches:
      - "main"
  pull_request:
  merge_group:

# ^^ This workflow does not run automatically, to make sure we don't burn through too many
# namespace.so credits. For now, it is only triggered manually if desired.

permissions:
  contents: write
  packages: write

jobs:
  #
  # Docker image builders
  #
  core-docker-img:
    name: Build Docker image for core library
    runs-on: namespace-profile-leanmlir-docker-cached 
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Setup Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: nscr.io/tenant_2411cf8f8l302/lean-mlir
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value=${{ github.sha }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}



  #
  # Evaluation & test jobs
  # 
  build-tools:
    name: tools, scaling, and auto-generated stmts
    runs-on: namespace-profile-leanmlir-docker-cached
    needs: core-docker-img
    container: "nscr.io/tenant_2411cf8f8l302/lean-mlir:${{ github.sha }}"
    defaults:
      run:
        working-directory: /code/lean-mlir
    steps:
      - name: Symlink .elan (to correct for GHA changing $HOME)
        run: '[ -e ~/.elan ] || ln -s /root/.elan ~/.elan'
      - name: Compile `mlirnatural` Executable üßê
        run: |
          lake -R build mlirnatural

      - name: Compile `opt` Executable üßê
        run: |
          lake -R build opt

#      This broke the build during a recent update
#      - name: LLVM opt round trip test
#        run: |
#          lake exec opt test/LLVMDialect/InstCombine/bb0.mlir

      - name: Compile Alive Scaling
        run: |
          lake -R build SSA.Projects.InstCombine.ScalingTest
