<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href="../../.././style.css"></link><link rel="stylesheet" href="../../.././src/pygments.css"></link><link rel="shortcut icon" href="../../.././favicon.ico"></link><link rel="prefetch" href="../../.././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Compiler.LCNF.Specialize</title><script defer="true" src="../../.././mathjax-config.js"></script><script defer="true" src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT="../../.././";</script><script>const MODULE_NAME="Lean.Compiler.LCNF.Specialize";</script><script type="module" src="../../.././search.js"></script><script type="module" src="../../.././how-about.js"></script><script type="module" src="../../.././instances.js"></script><script type="module" src="../../.././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label>Documentation</h1><p class="header_filename break_within"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span></p><form action="https://google.com/search" method="get" id="search_form"><input type="hidden" name="sitesearch" value="https://leanprover-community.github.io/mathlib4_docs"></input><input type="text" name="q" autocomplete="off"></input>&#32;
            <button id="search_button" onclick="javascript: form.action='../../.././search.html';">Search</button><button>Google site search</button></form></header><nav class="internal_nav"><h3><a class="break_within" href="#top"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span></a></h3><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href="../../.././Init.html">Init</a></li><li><a href="../../.././Lean/Compiler/Specialize.html">Lean.Compiler.Specialize</a></li><li><a href="../../.././Lean/Compiler/LCNF/Closure.html">Lean.Compiler.LCNF.Closure</a></li><li><a href="../../.././Lean/Compiler/LCNF/FVarUtil.html">Lean.Compiler.LCNF.FVarUtil</a></li><li><a href="../../.././Lean/Compiler/LCNF/Level.html">Lean.Compiler.LCNF.Level</a></li><li><a href="../../.././Lean/Compiler/LCNF/MonadScope.html">Lean.Compiler.LCNF.MonadScope</a></li><li><a href="../../.././Lean/Compiler/LCNF/PhaseExt.html">Lean.Compiler.LCNF.PhaseExt</a></li><li><a href="../../.././Lean/Compiler/LCNF/PrettyPrinter.html">Lean.Compiler.LCNF.PrettyPrinter</a></li><li><a href="../../.././Lean/Compiler/LCNF/Simp.html">Lean.Compiler.LCNF.Simp</a></li><li><a href="../../.././Lean/Compiler/LCNF/SpecInfo.html">Lean.Compiler.LCNF.SpecInfo</a></li><li><a href="../../.././Lean/Compiler/LCNF/ToExpr.html">Lean.Compiler.LCNF.ToExpr</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Compiler.LCNF.Specialize" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Cache"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">Cache</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.CacheEntry"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">CacheEntry</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.instInhabitedCacheEntry"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">instInhabitedCacheEntry</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.addEntry"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">addEntry</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.specCacheExt"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">specCacheExt</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.cacheSpec"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">cacheSpec</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.findSpecCache?"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">findSpecCache?</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Context"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">Context</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.State"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">State</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.SpecializeM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">SpecializeM</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.instMonadScopeSpecializeM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">instMonadScopeSpecializeM</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.isGround"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">isGround</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.withLetDecl"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">withLetDecl</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.collect"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">Collector</span>.<span class="name">collect</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.shouldSpecialize"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">shouldSpecialize</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.expandCodeDecls"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">expandCodeDecls</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.expandCodeDecls.go"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">expandCodeDecls</span>.<span class="name">go</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.mkKey"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">mkKey</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.mkSpecDecl"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">mkSpecDecl</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.mkSpecDecl.go"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">mkSpecDecl</span>.<span class="name">go</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.getRemainingArgs"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">getRemainingArgs</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.specializeApp?"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">specializeApp?</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.visitFunDecl"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">visitFunDecl</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.visitCode"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">visitCode</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.main"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">main</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Decl.specialize"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">specialize</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.specialize"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">specialize</span></a></div></nav><main>
<div class="decl" id="Lean.Compiler.LCNF.Specialize.Cache"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L20-L20">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">Cache</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn"><a href="../../.././Lean/Data/SMap.html#Lean.SMap">Lean.SMap</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.CacheEntry"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L22-L25">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.CacheEntry"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">CacheEntry</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><ul class="structure_fields" id="Lean.Compiler.LCNF.Specialize.CacheEntry.mk"><li id="Lean.Compiler.LCNF.Specialize.CacheEntry.key" class="structure_field"><div class="structure_field_info">key : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></div></li><li id="Lean.Compiler.LCNF.Specialize.CacheEntry.declName" class="structure_field"><div class="structure_field_info">declName : <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></div></li></ul><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.Compiler.LCNF.Specialize.CacheEntry" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.instInhabitedCacheEntry"><div class="instance"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L25-L25">source</a></div><div class="decl_header"><span class="decl_kind">instance</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.instInhabitedCacheEntry"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">instInhabitedCacheEntry</span></a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Init/Prelude.html#Inhabited">Inhabited</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.CacheEntry">Lean.Compiler.LCNF.Specialize.CacheEntry</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.instInhabitedCacheEntry">Lean.Compiler.LCNF.Specialize.instInhabitedCacheEntry</a> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn">{ <span class="fn">default</span> := <span class="fn">{ <span class="fn">key</span> := <span class="fn">default</span>, <span class="fn">declName</span> := <span class="fn">default</span> }</span> }</span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.addEntry"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L27-L28">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.addEntry"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">addEntry</span></a></span><span class="decl_args">
<span class="fn">(cache : <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a>)</span></span>
<span class="decl_args">
<span class="fn">(e : <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.CacheEntry">Lean.Compiler.LCNF.Specialize.CacheEntry</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.addEntry">Lean.Compiler.LCNF.Specialize.addEntry</a> <span class="fn">cache</span> <span class="fn">e</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn"><a href="../../.././Lean/Data/SMap.html#Lean.SMap.insert">Lean.SMap.insert</a> <span class="fn">cache</span> <span class="fn"><span class="fn">e</span>.key</span> <span class="fn"><span class="fn">e</span>.declName</span></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.specCacheExt"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L30-L34">source</a></div><div class="decl_header"><span class="decl_kind">opaque</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.specCacheExt"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">specCacheExt</span></a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Environment.html#Lean.SimplePersistentEnvExtension">Lean.SimplePersistentEnvExtension</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.CacheEntry">Lean.Compiler.LCNF.Specialize.CacheEntry</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a></span></div></div></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.cacheSpec"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L36-L37">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.cacheSpec"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">cacheSpec</span></a></span><span class="decl_args">
<span class="fn">(key : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args">
<span class="fn">(declName : <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/CoreM.html#Lean.Core.CoreM">Lean.CoreM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.findSpecCache?"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L39-L40">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.findSpecCache?"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">findSpecCache?</span></a></span><span class="decl_args">
<span class="fn">(key : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/CoreM.html#Lean.Core.CoreM">Lean.CoreM</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span>)</span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Context"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L42-L55">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Context"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">Context</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><ul class="structure_fields" id="Lean.Compiler.LCNF.Specialize.Context.mk"><li id="Lean.Compiler.LCNF.Specialize.Context.scope" class="structure_field"><div class="structure_field_doc"><p>Set of free variables in scope. The "collector" uses this information when collecting
dependencies for code specialization.</p></div><div class="structure_field_info">scope : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">Lean.FVarIdSet</a></div></li><li id="Lean.Compiler.LCNF.Specialize.Context.ground" class="structure_field"><div class="structure_field_doc"><p>Set of let-declarations in scope that do not depend on parameters.</p></div><div class="structure_field_info">ground : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">Lean.FVarIdSet</a></div></li><li id="Lean.Compiler.LCNF.Specialize.Context.declName" class="structure_field"><div class="structure_field_doc"><p>Name of the declaration being processed</p></div><div class="structure_field_info">declName : <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></div></li></ul><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.Compiler.LCNF.Specialize.Context" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.State"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L57-L58">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.State"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">State</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><ul class="structure_fields" id="Lean.Compiler.LCNF.Specialize.State.mk"><li id="Lean.Compiler.LCNF.Specialize.State.decls" class="structure_field"><div class="structure_field_info">decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></li></ul><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.Compiler.LCNF.Specialize.State" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.SpecializeM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L60-L60">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">SpecializeM</span></a></span><span class="decl_args">
<span class="fn">(α : <a href="../../.././foundational_types.html">Type</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Prelude.html#ReaderT">ReaderT</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Context">Lean.Compiler.LCNF.Specialize.Context</a>
    (<span class="fn"><a href="../../.././Init/Control/StateRef.html#StateRefT'">StateRefT'</a> <a href="../../.././Init/System/IO.html#IO.RealWorld">IO.RealWorld</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.State">Lean.Compiler.LCNF.Specialize.State</a> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a></span>)</span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.instMonadScopeSpecializeM"><div class="instance"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L62-L64">source</a></div><div class="decl_header"><span class="decl_kind">instance</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.instMonadScopeSpecializeM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">instMonadScopeSpecializeM</span></a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/MonadScope.html#Lean.Compiler.LCNF.MonadScope">Lean.Compiler.LCNF.MonadScope</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.isGround"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L70-L72">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.isGround"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">isGround</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{α : <a href="../../.././foundational_types.html">Type</a>}</span></span>
</span><span class="impl_arg"><span class="decl_args">
<span class="fn">[inst : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/FVarUtil.html#Lean.Compiler.LCNF.TraverseFVar">Lean.Compiler.LCNF.TraverseFVar</a> <span class="fn">α</span></span>]</span></span>
</span><span class="decl_args">
<span class="fn">(e : <span class="fn">α</span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Init/Prelude.html#Bool">Bool</a></span></div></div><p>Return <code>true</code> if <code>e</code> is a ground term. That is,
it contains only free variables tagged as ground</p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.isGround">Lean.Compiler.LCNF.Specialize.isGround</a> <span class="fn">e</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn">do
  let __do_lift ← <span class="fn">read</span>
  let s : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">Lean.FVarIdSet</a> := <span class="fn"><span class="fn">__do_lift</span>.ground</span>
  <span class="fn"><a href="../../.././Init/Prelude.html#Pure.pure">pure</a> (<span class="fn"><a href="../../.././Lean/Compiler/LCNF/FVarUtil.html#Lean.Compiler.LCNF.allFVar">Lean.Compiler.LCNF.allFVar</a> (<span class="fn">fun <span class="fn">x</span> =&gt <span class="fn"><a href="../../.././Lean/Data/RBTree.html#Lean.RBTree.contains">Lean.RBTree.contains</a> <span class="fn">s</span> <span class="fn">x</span></span></span>) <span class="fn">e</span></span>)</span></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.withLetDecl"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L74-L77">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.withLetDecl"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">withLetDecl</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{α : <a href="../../.././foundational_types.html">Type</a>}</span></span>
</span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.LetDecl">Lean.Compiler.LCNF.LetDecl</a>)</span></span>
<span class="decl_args">
<span class="fn">(x : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="mod_doc"><h1 class="markdown-heading" id="Dependency-collector-for-the-code-specialization-function">Dependency collector for the code specialization function. <a class="hover-link" href="#Dependency-collector-for-the-code-specialization-function">#</a></h1><p>During code specialization, we select which arguments are going to be used during the specialization.
Then, we have to collect their dependencies. For example, suppose are trying to specialize the following <code><a href="../../.././Init/System/IO.html#IO.println">IO.println</a></code>
and <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code> applications in the following example:</p><pre><code>    def f xs a.1 :=
      let _x.2 := @instMonadEIO <a href="../../.././Init/System/IOError.html#IO.Error">IO.Error</a>
      let _x.5 := <a href="../../.././Init/Data/ToString/Basic.html#instToStringString">instToStringString</a>
      let _x.9 := <a href="../../.././Init/Data/ToString/Basic.html#instToStringNat">instToStringNat</a>
      let _x.6 := "hello"
      let _x.61 := @IO.println <a href="../../.././Init/Prelude.html#String">String</a> _x.5 _x.6 a.1 -- (*)
      cases _x.61
      | <a href="../../.././Init/Prelude.html#EStateM.Result.ok">EStateM.Result.ok</a> a.6 a.7 =>
        fun _f.72 _y.69 _y.70 :=
          let _x.71 := @IO.println <a href="../../.././Init/Prelude.html#Nat">Nat</a> _x.9 _y.69 _y.70 -- (*)
          _x.71
        let _x.65 := @List.forM (fun α => <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> → <a href="../../.././Init/Prelude.html#EStateM.Result">EStateM.Result</a> <a href="../../.././Init/System/IOError.html#IO.Error">IO.Error</a> <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> α) _x.2 <a href="../../.././Init/Prelude.html#Nat">Nat</a> xs _f.72 a.7 -- (*)
        ...
      ...
</code></pre><p>For <code><a href="../../.././Init/System/IO.html#IO.println">IO.println</a></code> the <code>SpecArgInfo</code> is <code>[N, I, O, O]</code>, i.e., only the first two arguments are considered
for code specialization. The first one is computationally neutral, and the second one is an instance.
For <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code>, we have <code>[N, I, N, O, H]</code>. In this case, the fifth argument (tagged as <code>H</code>) is a function.
Note that the actual <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code> application has 6 arguments, the extra argument comes from the <code><a href="../../.././Init/System/IO.html#IO">IO</a></code> monad.</p><p>For the first <code><a href="../../.././Init/System/IO.html#IO.println">IO.println</a></code> application, the collector collects <code>_x.5</code>.
For the <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code>, it collects <code>_x.2</code>, <code>_x.9</code>, and <code>_f.72</code>.
The collected values are used to construct a key to identify the specialization. Arguments that were not considered are
replaced with <code><a href="../../.././Init/Prelude.html#lcErased">lcErased</a></code>. The key is used to make sure we don't keep generating the same specialization over and over again.
This is not an optimization, it is essential to prevent the code specializer from looping while specializing recursive functions.
The keys for these two applications are the terms.</p><pre><code>@IO.println <a href="../../.././Init/Prelude.html#Nat">Nat</a> <a href="../../.././Init/Data/ToString/Basic.html#instToStringNat">instToStringNat</a> <a href="../../.././Init/Prelude.html#lcErased">lcErased</a> <a href="../../.././Init/Prelude.html#lcErased">lcErased</a>
</code></pre><p>and</p><pre><code>@List.forM
  (fun α => <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> → <a href="../../.././Init/Prelude.html#EStateM.Result">EStateM.Result</a> <a href="../../.././Init/System/IOError.html#IO.Error">IO.Error</a> <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> α)
  (@instMonadEIO IO.Error) <a href="../../.././Init/Prelude.html#Nat">Nat</a> <a href="../../.././Init/Prelude.html#lcErased">lcErased</a>
  (fun _y.69 _y.70 =>
   let _x.71 := @IO.println <a href="../../.././Init/Prelude.html#Nat">Nat</a> <a href="../../.././Init/Data/ToString/Basic.html#instToStringNat">instToStringNat</a> _y.69 _y.70;
  _x.71)
</code></pre><p>The keys never contain free variables or loose bound variables.</p></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.collect"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L137-L152">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collect"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">Collector</span>.<span class="name">collect</span></a></span><span class="decl_args">
<span class="fn">(paramsInfo : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/SpecInfo.html#Lean.Compiler.LCNF.SpecParamInfo">Lean.Compiler.LCNF.SpecParamInfo</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(args : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Arg">Lean.Compiler.LCNF.Arg</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a>
  (<span class="fn"><span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Arg">Lean.Compiler.LCNF.Arg</a></span>)</span> <a href="../../.././Init/Prelude.html#Prod">×</a> <span class="fn"><span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span> <a href="../../.././Init/Prelude.html#Prod">×</a> <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span></span></span>)</span></div></div><p>Given the specialization mask <code>paramsInfo</code> and the arguments <code>args</code>,
collect their dependencies, and return an array <code>mask</code> of size <code>paramsInfo.size</code> s.t.</p><ul>
<li><code>mask[i] = some args[i]</code> if <code>paramsInfo[i] != .other</code></li>
<li><code>mask[i] = none</code>, otherwise.
That is, <code>mask</code> contains only the arguments that are contributing to the code specialization.
We use this information to compute a "key" to uniquely identify the code specialization, and
creating the specialized code.</li>
</ul><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.shouldSpecialize"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L159-L166">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.shouldSpecialize"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">shouldSpecialize</span></a></span><span class="decl_args">
<span class="fn">(paramsInfo : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/SpecInfo.html#Lean.Compiler.LCNF.SpecParamInfo">Lean.Compiler.LCNF.SpecParamInfo</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(args : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Arg">Lean.Compiler.LCNF.Arg</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Init/Prelude.html#Bool">Bool</a></span></div></div><p>Return <code>true</code> if it is worth using arguments <code>args</code> for specialization given the parameter specialization information.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.expandCodeDecls"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L172-L185">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.expandCodeDecls"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">expandCodeDecls</span></a></span><span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(body : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.LetValue">Lean.Compiler.LCNF.LetValue</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span></div></div><p>Convert the given declarations into <code>Expr</code>, and "zeta-reduce" them into body.
This function is used to compute the key that uniquely identifies an code specialization.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.expandCodeDecls.go"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L177-L183">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.expandCodeDecls.go"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">expandCodeDecls</span>.<span class="name">go</span></a></span><span class="decl_args">
<span class="fn">(body : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.LetValue">Lean.Compiler.LCNF.LetValue</a>)</span></span>
<span class="decl_args">
<span class="fn">(xs : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(values : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(i : <a href="../../.././Init/Prelude.html#Nat">Nat</a>)</span></span>
<span class="decl_args">
<span class="fn">(subst : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.mkKey"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L193-L198">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.mkKey"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">mkKey</span></a></span><span class="decl_args">
<span class="fn">(params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(body : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.LetValue">Lean.Compiler.LCNF.LetValue</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a> (<span class="fn"><a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a> <a href="../../.././Init/Prelude.html#Prod">×</a> <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span></span>)</span></div></div><p>Create the "key" that uniquely identifies a code specialization.
<code>params</code> and <code><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.State.decls">decls</a></code> are the declarations collected by the <code><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collect">collect</a></code> function above.
The result contains the list of universe level parameter names the key that <code>params</code>, <code><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.State.decls">decls</a></code>, and <code>body</code> depends on.
We use this information to create the new auxiliary declaration and resulting application.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.mkSpecDecl"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L209-L245">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.mkSpecDecl"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">mkSpecDecl</span></a></span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args">
<span class="fn">(us : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Lean/Level.html#Lean.Level">Lean.Level</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(argMask : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Arg">Lean.Compiler.LCNF.Arg</a></span>)</span>)</span></span>
<span class="decl_args">
<span class="fn">(params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(levelParamsNew : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></div><p>Specialize <code>decl</code> using</p><ul>
<li><code>us</code>: the universe level used to instantiate <code>decl.name</code></li>
<li><code>argMask</code>: arguments that are being used to specialize the declaration.</li>
<li><code>params</code>: new parameters that arguments in <code>argMask</code> depend on.</li>
<li><code><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.State.decls">decls</a></code>: local declarations that arguments in <code>argMask</code> depend on.</li>
<li><code>levelParamsNew</code>: the universe level parameters for the new declaration.</li>
</ul><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.mkSpecDecl.go"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L223-L245">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.mkSpecDecl.go"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">mkSpecDecl</span>.<span class="name">go</span></a></span><span class="decl_args">
<span class="fn">(us : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Lean/Level.html#Lean.Level">Lean.Level</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(argMask : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Arg">Lean.Compiler.LCNF.Arg</a></span>)</span>)</span></span>
<span class="decl_args">
<span class="fn">(params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(levelParamsNew : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args">
<span class="fn">(nameNew : <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Internalize.html#Lean.Compiler.LCNF.Internalize.InternalizeM">Lean.Compiler.LCNF.Internalize.InternalizeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.getRemainingArgs"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L251-L256">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.getRemainingArgs"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">getRemainingArgs</span></a></span><span class="decl_args">
<span class="fn">(paramsInfo : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/SpecInfo.html#Lean.Compiler.LCNF.SpecParamInfo">Lean.Compiler.LCNF.SpecParamInfo</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(args : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Arg">Lean.Compiler.LCNF.Arg</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Arg">Lean.Compiler.LCNF.Arg</a></span></div></div><p>Given the specialization mask <code>paramsInfo</code> and the arguments <code>args</code>,
return the arguments that have not been considered for specialization.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.specializeApp?"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L263-L295">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.specializeApp?"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">specializeApp?</span></a></span><span class="decl_args">
<span class="fn">(e : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.LetValue">Lean.Compiler.LCNF.LetValue</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.LetValue">Lean.Compiler.LCNF.LetValue</a></span>)</span></div></div><p>Try to specialize the function application in the given let-declaration.
<code>k</code> is the continuation for the let-declaration.</p></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.visitFunDecl"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L297-L299">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.visitFunDecl"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">visitFunDecl</span></a></span><span class="decl_args">
<span class="fn">(funDecl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.FunDecl">Lean.Compiler.LCNF.FunDecl</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.FunDecl">Lean.Compiler.LCNF.FunDecl</a></span></div></div></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.visitCode"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L301-L319">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.visitCode"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">visitCode</span></a></span><span class="decl_args">
<span class="fn">(code : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Code">Lean.Compiler.LCNF.Code</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Code">Lean.Compiler.LCNF.Code</a></span></div></div></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.main"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L323-L328">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.main"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Specialize</span>.<span class="name">main</span></a></span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Decl.specialize"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L332-L334">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Decl.specialize"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">specialize</span></a></span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span>)</span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.specialize"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/ebc32af2e606deef0d7b437e67f24c20ed866818/src/Lean/Compiler/LCNF/Specialize.lean#L336-L341">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.specialize"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">specialize</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass">Lean.Compiler.LCNF.Pass</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div></main>
<nav class="nav"><iframe src="../../.././navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>